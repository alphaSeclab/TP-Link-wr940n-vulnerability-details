# tplink wr940n authed remote command injection

## I. Overview

- Discoverer: CFF of Topsec Alpha Team
- Product Affected: TP-Link wr940n Router
- Firmware Version: 3.20.1 Build 200316 Rel.34392n (4555)

## II. Vulnerability details

After POST data to WanStaticIpV6CfgRpm.htm which include dnsservere1 and dnsserver2, router will setting the dns as blow.

![image-20200911163823772](./images/image-20200911163823772.png)

![image-20200911162610965](./images/image-20200911162610965.png)

When the dnsserver1 and dnsserver2 setted payload like '2001:4868:4802:34:0:0:0:c";reboot;"' it will cause command injection.

## III. PoC

### step 1. goto the ipv6 setup

![image-20200911163146854](./images/image-20200911163146854.png)

### step 2. add breakpoint on dataEncrypt

open web browser's devtools, add breakpoint on common.js before dataEncrypt.

![image-20200911163315258](./images/image-20200911163315258.png)

### step 3. setting ipv6 data and click save

![image-20200911163945196](./images/image-20200911163945196.png)

![image-20200911164106042](./images/image-20200911164106042.png)

after click save button, breakpoint will triggered

### step 4. using console change form.dnsserver1.value to payload

![image-20200911164206177](./images/image-20200911164206177.png)

after change this click run.

### step 5. the router will reboot after post data

uart output, reboot command executed!!

![image-20200911164319715](./images/image-20200911164319715.png)

TP-LINK fixed this problem

![fixed](./images/fixed.png)

# IV. Impact

Authorized users can execute any command.

# V. Report timeline

2020-09-14 reported the vulnerability

2020-09-18 tplink acknowledged the report

2020-09-24 tplink sent me the fixed version for testing

2020-09-25 reported this version not fix the vulnerability

2020-10-12 tplink sent me new fixed version for testing

2020-10-13 I confirmed the fix and replied back