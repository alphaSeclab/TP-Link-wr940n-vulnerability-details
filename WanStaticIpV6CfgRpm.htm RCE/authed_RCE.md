# authed remote command injection

## I. Overview

- Discoverer: CQY of Topsec Alpha Team

- Affected Product: TP-LINK wr940n Router

- Firmware Version: TL-WR940N(EU)_V6_200316

## II. Vulnerability Details

- The router gets the value of the staticPrefix variable, but does not check the validity of the value, and stores it at offset 0x8 of LanIpv6 configuration file.

  ![staticPrefix](.\images\staticPrefix.png)

- In the sub_55F524 function, the route will use prefix we provided to add a new IP address. When the staticPrefix setted payload like “`ping -c 1 192.168.0.100`”, it will cause command injection.

  ![Details](.\images\Details.png)

## III. Poc

### step 1. open the IPv6 Setup

![ipv6_setup](.\images\ipv6_setup.png)

### step 2. add breakpoint on dataEncrypt

open web browser's devtools, add breakpoint on common.js before dataEncrypt.

![add_breakpoint](.\images\add_breakpoint.png)

### step 3. setting staticPrefix and click save

![setting staticPrefix](.\images\setting staticPrefix.png)

after click save button, breakpoint will triggered

### step 4. using console change form.staticPrefix.value to payload

![add_payload](.\images\add_payload.png)

after change this click run.

### step 5. the command will be executed after post data

Wireshark only captures ICMP packets once, indicating that the ping command executed successfully. 

![RCE](.\images\RCE.png)

TP-LINK fixed this problem

![tplink fixed](.\images\tplink_fixed.png)

## IV. Impact

Authorized users can execute any command.

## V. Report timeline

- 16/03/2021 Report to TP-Link
- 18/03/2021 TP-Link confirm issue and fixed