# authed remote command injection

## I. Overview

- Discoverer: CQY of Topsec Alpha Team

- Affected Product: TP-LINK wr940n Router

- Firmware Version: wr940nv6_eu_3_20_1_up_boot(210318)

## II. Vulnerability Details

- The router gets the value of the PPTPServereName variable, but does not check the validity of the value, and stores it at offset 0x1C of PPTP configuration file.

![PPTPServerName](./images/PPTPServerName.png)

- In the swSetPptpCfg function,the route will read the original configuration,and then determine whether it is static IP type,if so, delete the original route entry.

  ![Details](.\images\Details.png)

## III. Poc

### step 1. open the PPTP configuration

![goto_PPTP_setup](.\images\goto_PPTP_setup.png)

### step 2. add breakpoint on dataEncrypt

open web browser's devtools, add breakpoint on common.js before dataEncrypt.

![add_breakpoint](.\images\add_breakpoint.png)

### step 3. setting PPTP configuration and click save

![setting_PPTPServerName](.\images\setting_PPTPServerName.png)

after click save button, breakpoint will triggered

### step 4. using console change form.PPTPServereName.value to payload

![add_payload](.\images\add_payload.png)

after change this click run.

### step 5. the command will be executed after post data

Wireshark only captures ICMP packets once, indicating that the ping command executed successfully. 

![RCE](.\images\RCE.png)

TP-LINK fixed this problem

![tplink fixed](.\images\tplink_fixed.png)

## IV. Impact

Authorized users can execute any command

## V. Report timeline

- 19/03/2021 Report to TP-Link
- 25/03/2021 TP-Link confirm issue and fixed