# authed remote command injection

## I. Overview

- Discoverer: CQY of Topsec Alpha Team

- Affected Product: TP-LINK wr940n Router

- Firmware Version: wr940nv6_eu_3_20_1_up_boot(210318)

## II. Vulnerability Details

- The router gets the value of the PPTPServereName variable, but does not check the validity of the value, and stores it at offset 0x1C of PPTP configuration file.

  <div  align="center"><img src="./images/PPTPServerName.png" width = "50%" height = "50%" alt="PPTPServerName" align=center /></div>

- In the swSetPptpCfg function,the route will read the original configuration,and then determine whether it is static IP type,if so, delete the original route entry.

  <div  align="center"><img src="./images/Details.png" width = "50%" height = "50%" alt="Details" align=center /></div>

## III. PoC

### step 1. open the PPTP configuration

<div  align="center"><img src="./images/goto_PPTP_setup.png" width = "50%" height = "50%" alt="goto_PPTP_setup" align=center /></div>

### step 2. add breakpoint on dataEncrypt

open web browser's devtools, add breakpoint on common.js before dataEncrypt.

<div  align="center"><img src="./images/add_breakpoint.png" width = "50%" height = "50%" alt="add_breakpoint" align=center /></div>

### step 3. setting PPTP configuration and click save

<div  align="center"><img src="./images/setting_PPTPServerName.png" width = "50%" height = "50%" alt="setting_PPTPServerName" align=center /></div>

after click save button, breakpoint will triggered

### step 4. using console change form.PPTPServereName.value to payload

<div  align="center"><img src="./images/add_payload.png" width = "50%" height = "50%" alt="add_payload" align=center /></div>

after change this click run.

### step 5. the command will be executed after post data

Wireshark only captures ICMP packets once, indicating that the ping command executed successfully. 

<div  align="center"><img src="./images/RCE.png" width = "50%" height = "50%" alt="RCE" align=center /></div>

TP-LINK fixed this problem

<div  align="center"><img src="./images/tplink_fixed.png" width = "50%" height = "50%" alt="tplink_fixed" align=center /></div>

## IV. Impact

Authorized users can execute any command

## V. Report timeline

- 19/03/2021 Report to TP-Link
- 25/03/2021 TP-Link confirm issue and fixed