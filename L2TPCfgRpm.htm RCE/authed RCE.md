# authed remote command injection

## I. Overview

- Discoverer: CQY of Topsec Alpha Team

- Affected Product: TP-LINK wr940n Router

- Firmware Version: wr940nv6_eu_3_20_1_up_boot(210318)

## II. Vulnerability Details

- The router gets the value of the L2TPServereName variable, but does not check the validity of the value, and stores it at offset 0x1C of L2TP configuration file.

  <div  align="center"><img src="./images/L2TPServerName.png" width = "50%" height = "50%" alt="L2TPServerName" align=center /></div>

- In the swSetL2tpCfg functionï¼Œthe route will read the original configuration,and then compare whether the current user name and password are consistent with the original,if not, the original route entry will be deleted.

  <div  align="center"><img src="./images/Details.png" width = "50%" height = "50%" alt="Details" align=center /></div>

## III. PoC

### step 1. open the WAN configuration

<div  align="center"><img src="./images/goto_L2TP_setup.png" width = "50%" height = "50%" alt="goto_L2TP_setup" align=center /></div>

### step 2. add breakpoint on dataEncrypt

open web browser's devtools, add breakpoint on common.js before dataEncrypt.

<div  align="center"><img src="./images/add_breakpoint.png" width = "50%" height = "50%" alt="add_breakpoint" align=center /></div>

### step 3. setting WAN configuration and click save

<div  align="center"><img src="./images/setting_L2TPServerName.png" width = "50%" height = "50%" alt="setting_L2TPServerName" align=center /></div>

after click save button, breakpoint will triggered

### step 4. using console change form.L2TPServerName.value to payload

<div  align="center"><img src="./images/add_payload.png" width = "50%" height = "50%" alt="add_payload" align=center /></div>

after change this click run.

### step 5. the command will be executed after post data

Wireshark only captures ICMP packets once, indicating that the ping command executed successfully. 

<div  align="center"><img src="./images/RCE.png" width = "50%" height = "50%" alt="RCE" align=center /></div>

TP-LINK fixed this problem.

<div  align="center"><img src="./images/tplink_fixed.png" width = "50%" height = "50%" alt="tplink_fixed" align=center /></div>

## IV. Impact

Authorized users can execute any command

## V. Report timeline

- 19/03/2021 Report to TP-Link
- 25/03/2021 TP-Link confirm issue and fixed