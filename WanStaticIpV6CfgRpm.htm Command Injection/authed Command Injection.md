# authed remote command injection

## I. Overview

- Discoverer: CQY of Topsec Alpha Team

- Affected Product: TP-LINK wr940n Router

- Firmware Version: TL-WR940N(EU)_V6_200316

## II. Vulnerability Details

- The router gets the value of the staticPrefix variable, but does not check the validity of the value, and stores it at offset 0x8 of LanIpv6 configuration file.

  <div  align="center"><img src="./images/staticPrefix.png" width = "50%" height = "50%" alt="staticPrefix" align=center /></div>

- In the sub_55F524 function, the route will use prefix we provided to add a new IP address. When the staticPrefix setted payload like “`ping -c 1 192.168.0.100`”, it will cause command injection.

  <div  align="center"><img src="./images/Details.png" width = "50%" height = "50%" alt="Details" align=center /></div>

## III. PoC

### step 1. open the IPv6 Setup

<div  align="center"><img src="./images/ipv6_setup.png" width = "50%" height = "50%" alt="ipv6_setup" align=center /></div>

### step 2. add breakpoint on dataEncrypt

open web browser's devtools, add breakpoint on common.js before dataEncrypt.

<div  align="center"><img src="./images/add_breakpoint.png" width = "50%" height = "50%" alt="add_breakpoint" align=center /></div>

### step 3. setting staticPrefix and click save

<div  align="center"><img src="./images/setting staticPrefix.png" width = "50%" height = "50%" alt="setting staticPrefix" align=center /></div>

after click save button, breakpoint will triggered

### step 4. using console change form.staticPrefix.value to payload

<div  align="center"><img src="./images/add_payload.png" width = "50%" height = "50%" alt="add_payload" align=center /></div>

after change this click run.

### step 5. the command will be executed after post data

Wireshark only captures ICMP packets once, indicating that the ping command executed successfully. 

<div  align="center"><img src="./images/RCE.png" width = "50%" height = "50%" alt="RCE" align=center /></div>

TP-LINK fixed this problem

<div  align="center"><img src="./images/tplink_fixed.png" width = "50%" height = "50%" alt="tplink fixed" align=center /></div>

## IV. Impact

Authorized users can execute any command.

## V. Report timeline

- 16/03/2021 Report to TP-Link
- 18/03/2021 TP-Link confirm issue and fixed