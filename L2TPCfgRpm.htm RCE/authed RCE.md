# authed remote command injection

## I. Overview

- Discoverer: topsec(CQY)

- Affected Product: TP-LINK wr940n Router

- Firmware Version: wr940nv6_eu_3_20_1_up_boot(210318)

## II. Vulnerability Details

- The router gets the value of the L2TPServereName variable, but does not check the validity of the value, and stores it at offset 0x1C of L2TP configuration file.

![L2TPServerName](./images/L2TPServerName.png)

- In the swSetL2tpCfg function，the route will read the original configuration,and then compare whether the current user name and password are consistent with the original,if not, the original route entry will be deleted.

  ![Details](.\images\Details.png)

## III. Poc

### step 1. open the WAN configuration

![goto_L2TP_setup](.\images\goto_L2TP_setup.png)

### step 2. add breakpoint on dataEncrypt

open web browser's devtools, add breakpoint on common.js before dataEncrypt.

![add_breakpoint](.\images\add_breakpoint.png)

### step 3. setting WAN configuration and click save

![setting_L2TPServerName](.\images\setting_L2TPServerName.png)

after click save button, breakpoint will triggered

### step 4. using console change form.L2TPServerName.value to payload

![add_payload](.\images\add_payload.png)

after change this click run.

### step 5. the router will reboot after post data

Wireshark only captures ICMP packets once, indicating that the ping command executed successfully. 

![RCE](.\images\RCE.png)

TP-LINK fixed this problem

![tplink fixed](.\images\tplink fixed.png)

## IV. Impact

Authorized users can execute any command

## V. Report timeline

–    19/03/2021 Report to TP-Link
–    25/03/2020 TP-Link confirm issue and fixed