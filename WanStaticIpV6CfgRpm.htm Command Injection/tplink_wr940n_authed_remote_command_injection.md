# tplink wr940n authed remote command injection

## I. Overview

- Discoverer: CFF of Topsec Alpha Team
- Product Affected: TP-Link wr940n Router
- Firmware Version: 3.20.1 Build 200316 Rel.34392n (4555)

## II. Vulnerability details

After POST data to WanStaticIpV6CfgRpm.htm which include dnsservere1 and dnsserver2, router will setting the dns as blow.

<div  align="center"><img src="./images/image-20200911163823772.png" width = "50%" height = "50%" alt="image-20200911163823772" align=center /></div>

<div  align="center"><img src="./images/image-20200911162610965.png" width = "50%" height = "50%" alt="image-20200911162610965" align=center /></div>

When the dnsserver1 and dnsserver2 setted payload like '2001:4868:4802:34:0:0:0:c";reboot;"' it will cause command injection.

## III. PoC

### step 1. goto the ipv6 setup

<div  align="center"><img src="./images/image-20200911163146854.png" width = "50%" height = "50%" alt="image-20200911163146854" align=center /></div>

### step 2. add breakpoint on dataEncrypt

open web browser's devtools, add breakpoint on common.js before dataEncrypt.

<div  align="center"><img src="./images/image-20200911163315258.png" width = "50%" height = "50%" alt="image-20200911163315258" align=center /></div>

### step 3. setting ipv6 data and click save

<div  align="center"><img src="./images/image-20200911163945196.png" width = "50%" height = "50%" alt="image-20200911163945196" align=center /></div>

<div  align="center"><img src="./images/image-20200911164106042.png" width = "50%" height = "50%" alt="image-20200911164106042" align=center /></div>

after click save button, breakpoint will triggered

### step 4. using console change form.dnsserver1.value to payload

<div  align="center"><img src="./images/image-20200911164206177.png" width = "50%" height = "50%" alt="image-20200911164206177" align=center /></div>

after change this click run.

### step 5. the router will reboot after post data

uart output, reboot command executed!!

<div  align="center"><img src="./images/image-20200911164319715.png" width = "50%" height = "50%" alt="image-20200911164319715" align=center /></div>

TP-LINK fixed this problem

<div  align="center"><img src="./images/fixed.png" width = "50%" height = "50%" alt="fixed" align=center /></div>

# IV. Impact

Authorized users can execute any command.

# V. Report timeline

2020-09-14 reported the vulnerability

2020-09-18 tplink acknowledged the report

2020-09-24 tplink sent me the fixed version for testing

2020-09-25 reported this version not fix the vulnerability

2020-10-12 tplink sent me new fixed version for testing

2020-10-13 I confirmed the fix and replied back